# 绩效系统升级记录 - v2.1.0 角色与业绩整合

**日期**：2026-01-20
**版本**：v2.1.0
**备份位置**：`backup/code_backup/app_v2.1.0_角色与业绩整合_20260120`

---

## 一、升级目标

将"计件工具"升级为"综合绩效管理系统"，支持：
- 不同岗位角色有不同达标标准
- 多元化收入构成（计件、开单奖励、管理津贴、业绩提成、排名奖金）
- 导入门店营业额、开单量等外部数据

---

## 二、新增数据文件

| 文件 | 路径 | 用途 |
|------|------|------|
| roles.json | `data/roles.json` | 岗位角色配置 |
| income_rules.json | `data/income_rules.json` | 收入类型规则定义 |
| external_data.json | `data/external_data.json` | 外部数据（营业额、开单量） |
| bonus_pools.json | `data/bonus_pools.json` | 排名奖金池配置 |

---

## 三、新增页面

| 页面 | 文件 | 功能 |
|------|------|------|
| 角色管理 | `app/pages/role_page.py` | 配置角色、达标线倍率、收入类型 |
| 外部数据导入 | `app/pages/external_data_page.py` | 导入营业额、开单量等 |
| 奖金池管理 | `app/pages/bonus_pool_page.py` | 配置排名奖金分配规则 |

---

## 四、角色配置详解

### 4.1 预设角色

| 角色ID | 名称 | 达标线倍率 | 收入类型 | 特殊配置 |
|--------|------|-----------|---------|---------|
| role_001 | 生产人员 | 1.0x | 技能工资 + 阶梯奖金 | 无 |
| role_002 | 前台文员 | 0.4x | 技能工资 + 阶梯奖金 + 开单奖励 | 开单2元/单 |
| role_003 | 实习主管 | 1.0x | 技能工资 + 阶梯奖金 + 管理津贴 | 津贴500元/月 |
| role_004 | 正式主管 | 1.0x | 技能工资 + 阶梯奖金 + 业绩提成 | 提成1% |

### 4.2 达标线计算规则

**优先级**：员工自定义 > 角色倍率 > 区域默认值

```
员工达标线 = 区域默认达标线 × 角色倍率

例如：印前区域默认30000，前台文员倍率0.4
前台文员印前达标线 = 30000 × 0.4 = 12000
```

### 4.3 如何修改角色配置

1. 进入【角色管理】页面
2. 点击"编辑角色"展开
3. 选择角色，修改：
   - 达标线倍率（0.0 ~ 2.0）
   - 勾选收入类型
   - 填写对应配置（开单单价、津贴金额、提成比例）
4. 保存修改

---

## 五、收入类型详解

| 类型ID | 名称 | 计算方式 | 数据来源 |
|--------|------|---------|---------|
| skill_salary | 技能工资 | 按技能累加 | 员工技能表 |
| ladder_bonus | 阶梯奖金 | 按绩效分阶梯 | 绩效数据 |
| order_bonus | 开单奖励 | 开单数 × 单价 | 外部数据 |
| management_allowance | 管理津贴 | 固定金额 | 角色配置 |
| revenue_commission | 业绩提成 | 营业额 × 比例 | 外部数据 |
| ranking_bonus | 排名奖金 | 奖池按排名分配 | 奖金池配置 |

---

## 六、外部数据导入说明

### 6.1 支持的数据类型

- **开单数量**：员工本月开单数
- **关联营业额**：员工关联的门店营业额
- **门店营业额**：各门店总营业额

### 6.2 导入方式

1. **手动录入**：逐个员工输入
2. **Excel导入**：批量导入
3. **门店营业额**：按门店录入

### 6.3 数据格式（Excel导入）

| 列 | 内容 |
|---|------|
| 第1列 | 员工姓名或工号 |
| 第2列 | 开单数量 |
| 第3列 | 关联营业额（可选） |
| 第4列 | 门店ID（可选） |

---

## 七、奖金池配置说明

### 7.1 配置项

| 配置项 | 说明 |
|--------|------|
| 奖金池名称 | 如"月度绩效排名奖" |
| 奖金总额 | 本池总金额 |
| 排名依据 | 绩效总分 / 工资总额 / 指定区域绩效 |
| 限定角色 | 只有该角色参与排名（留空=全员） |
| 分配规则 | 第1名多少钱、第2名多少钱... |

### 7.2 默认配置

```json
{
  "name": "月度绩效排名奖",
  "total_amount": 1000,
  "ranking_basis": "total_score",
  "distribution_rules": [
    {"rank": 1, "amount": 500, "description": "第一名"},
    {"rank": 2, "amount": 300, "description": "第二名"},
    {"rank": 3, "amount": 200, "description": "第三名"}
  ]
}
```

---

## 八、员工数据扩展

`employees.json` 新增字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| role_id | string | 岗位角色ID，如 "role_002" |
| store_id | string | 所属门店，如 "总店" |
| custom_settings | object | 个人特殊配置 |

### custom_settings 结构

```json
{
  "custom_threshold": true,  // 是否使用自定义达标线
  "thresholds": {
    "region_001": 15000,  // 印前自定义达标线
    "region_002": 20000   // 印中自定义达标线
  }
}
```

---

## 九、计算结果变化

计算结果新增字段：

| 字段 | 说明 |
|------|------|
| role_name | 员工角色名称 |
| regions[].threshold | 该员工在该区域的个性化达标线 |
| extra_income | 额外收入明细（开单奖励、津贴、提成、排名奖金） |

---

## 十、文件修改清单

### 10.1 新建文件

```
data/roles.json              # 角色配置
data/income_rules.json       # 收入规则
data/external_data.json      # 外部数据
data/bonus_pools.json        # 奖金池配置
app/pages/role_page.py       # 角色管理页面
app/pages/external_data_page.py  # 外部数据导入页面
app/pages/bonus_pool_page.py # 奖金池管理页面
```

### 10.2 修改文件

```
app/data_manager.py          # 新增角色、外部数据、奖金池管理函数
app/pages/employee_page.py   # 新增角色选择、门店分配
app/pages/calculate_page.py  # 支持角色达标线、多元收入、排名奖金
app/main.py                  # 新增页面路由和首页入口
requirements.txt             # 锁定依赖版本
```

---

## 十一、首页功能入口

升级后首页共 11 个功能入口：

**第一行（基础配置）**：
1. 员工管理
2. 角色管理 ✨新增
3. 工作区域
4. 工作技能
5. 技能指派

**第二行（数据与计算）**：
1. 绩效导入
2. 外部数据 ✨新增
3. 奖金池 ✨新增
4. 绩效计算
5. 历史查询
6. 方案管理

---

## 十二、常见问题

### Q1: 如何给员工设置不同的达标线？

**方法一**：通过角色（推荐）
1. 在【角色管理】创建/编辑角色，设置达标线倍率
2. 在【员工管理】给员工分配角色

**方法二**：员工自定义
1. 直接修改 `employees.json`
2. 添加 `custom_settings.custom_threshold = true`
3. 设置 `custom_settings.thresholds.region_xxx = 具体值`

### Q2: 外部数据没导入，计算会出错吗？

不会。外部数据是可选的，没有导入时：
- 开单奖励 = 0
- 业绩提成 = 0

### Q3: 奖金池不想用了怎么办？

在【奖金池管理】页面，编辑对应奖金池，取消勾选"启用"即可。

---

## 十三、后续待完善

1. [ ] 数据模型文档化
2. [ ] 预留 API 接口
3. [ ] JSON → PostgreSQL 迁移脚本

---

## 十四、依赖变更

```diff
- pandas>=1.5.0
+ pandas==2.3.1

- openpyxl>=3.0.0
+ openpyxl==3.1.5

- lxml>=4.9.0
+ lxml==6.0.2

- xlrd>=2.0.0
+ xlrd==2.0.2
```

**线上部署注意**：推送后需执行 `pip install -r requirements.txt` 更新依赖。
